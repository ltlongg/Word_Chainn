<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·ª´ v·ª±ng - Word Chain</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/animations.css">
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Authentication Screen -->
    <div id="authScreen" class="hidden">
        <div class="min-h-screen flex items-center justify-center px-4">
            <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-bold text-indigo-600 mb-2">üéÆ Word Chain</h1>
                    <p class="text-gray-600">ƒêƒÉng nh·∫≠p ƒë·ªÉ xem t·ª´ v·ª±ng</p>
                </div>

                <!-- Login Form -->
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="loginEmail" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">M·∫≠t kh·∫©u</label>
                        <input type="password" id="loginPassword" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    <button type="submit"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition-all transform hover:scale-105">
                        ƒêƒÉng nh·∫≠p
                    </button>
                    <p class="text-center text-sm text-gray-600">
                        Ch∆∞a c√≥ t√†i kho·∫£n? <a href="index.html" class="text-indigo-600 hover:underline">Quay v·ªÅ trang ch·ªß</a>
                    </p>
                </form>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Navigation Bar -->
        <div id="navbar"></div>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-indigo-600">üìñ T·ª´ v·ª±ng c·ªßa t√¥i</h1>
                    <button onclick="vocabularyManager.showAddWord()"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-semibold">
                        + Th√™m t·ª´ m·ªõi
                    </button>
                </div>

                <!-- Filter and Search -->
                <div class="mb-6 flex gap-4">
                    <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm t·ª´ v·ª±ng..."
                        onkeyup="vocabularyManager.filterWords()"
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">

                    <select id="filterMastery" onchange="vocabularyManager.filterWords()"
                        class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="0">M·ªõi h·ªçc (0)</option>
                        <option value="1">ƒêang h·ªçc (1)</option>
                        <option value="2">Quen thu·ªôc (2)</option>
                        <option value="3">Thu·ªôc (3)</option>
                        <option value="4">Th√†nh th·∫°o (4)</option>
                        <option value="5">Ho√†n h·∫£o (5)</option>
                    </select>
                </div>

                <!-- Statistics Summary -->
                <div id="vocabStats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-blue-700" id="totalWords">0</div>
                        <div class="text-xs text-blue-600">T·ªïng t·ª´</div>
                    </div>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-green-700" id="masteredWords">0</div>
                        <div class="text-xs text-green-600">Th√†nh th·∫°o</div>
                    </div>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-yellow-700" id="learningWords">0</div>
                        <div class="text-xs text-yellow-600">ƒêang h·ªçc</div>
                    </div>
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-purple-700" id="dueWords">0</div>
                        <div class="text-xs text-purple-600">C·∫ßn √¥n</div>
                    </div>
                </div>

                <!-- Vocabulary List -->
                <div id="vocabularyList">
                    <div class="text-center py-8 text-gray-500">ƒêang t·∫£i...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Word Modal -->
    <div id="addWordModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-6 max-w-md w-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-indigo-600">‚ûï Th√™m t·ª´ m·ªõi</h2>
                <button onclick="vocabularyManager.closeAddWord()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <form id="addWordForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">T·ª´ v·ª±ng</label>
                    <input type="text" id="newWord" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
                <button type="submit"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-semibold">
                    Th√™m t·ª´
                </button>
            </form>
        </div>
    </div>

    <!-- Word Detail Modal -->
    <div id="wordDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-indigo-600" id="detailWord"></h2>
                <button onclick="vocabularyManager.closeDetail()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="wordDetailContent"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/navigation.js"></script>
    <script src="js/vocabulary.js"></script>

    <script>
        // Vocabulary Manager for this page
        class VocabularyPageManager {
            constructor() {
                this.words = [];
                this.filteredWords = [];
            }

            async init() {
                await this.loadWords();
            }

            async loadWords() {
                try {
                    const response = await api.getVocabulary(1000, 0);
                    if (response.success) {
                        this.words = response.data.words || [];
                        this.filteredWords = [...this.words];
                        this.renderWords();
                        this.updateStats();
                    }
                } catch (error) {
                    console.error('Failed to load vocabulary:', error);
                }
            }

            filterWords() {
                const search = document.getElementById('searchInput').value.toLowerCase();
                const mastery = document.getElementById('filterMastery').value;

                this.filteredWords = this.words.filter(word => {
                    const matchesSearch = word.word.toLowerCase().includes(search);
                    const matchesMastery = !mastery || word.mastery == mastery;
                    return matchesSearch && matchesMastery;
                });

                this.renderWords();
            }

            renderWords() {
                const container = document.getElementById('vocabularyList');

                if (this.filteredWords.length === 0) {
                    container.innerHTML = '<div class="text-center py-8 text-gray-500">Kh√¥ng t√¨m th·∫•y t·ª´ v·ª±ng</div>';
                    return;
                }

                const masteryColors = ['gray', 'red', 'orange', 'yellow', 'green', 'blue'];
                const masteryLabels = ['M·ªõi h·ªçc', 'ƒêang h·ªçc', 'Quen thu·ªôc', 'Thu·ªôc', 'Th√†nh th·∫°o', 'Ho√†n h·∫£o'];

                container.innerHTML = `
                    <div class="grid gap-3">
                        ${this.filteredWords.map(word => {
                            const color = masteryColors[word.mastery || 0];
                            const label = masteryLabels[word.mastery || 0];

                            return `
                                <div class="bg-${color}-50 border border-${color}-200 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer"
                                    onclick="vocabularyManager.showDetail('${word._id}')">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <div class="font-bold text-lg text-${color}-800">${word.word}</div>
                                            <div class="text-sm text-gray-600 mt-1">${word.translation || ''}</div>
                                            <div class="text-xs text-gray-500 mt-2">
                                                S·ª≠ d·ª•ng: ${word.usageCount || 0} l·∫ßn | Th√†nh th·∫°o: ${label}
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-xs font-semibold text-${color}-600">${label}</div>
                                            <div class="text-2xl mt-1">${this.getMasteryIcon(word.mastery || 0)}</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            getMasteryIcon(mastery) {
                const icons = ['üìù', 'üìó', 'üìò', 'üìô', 'üìï', '‚≠ê'];
                return icons[mastery] || 'üìù';
            }

            updateStats() {
                document.getElementById('totalWords').textContent = this.words.length;
                document.getElementById('masteredWords').textContent = this.words.filter(w => (w.mastery || 0) >= 4).length;
                document.getElementById('learningWords').textContent = this.words.filter(w => (w.mastery || 0) > 0 && (w.mastery || 0) < 4).length;

                const now = new Date();
                document.getElementById('dueWords').textContent = this.words.filter(w => w.nextReview && new Date(w.nextReview) <= now).length;
            }

            showAddWord() {
                document.getElementById('addWordModal').classList.remove('hidden');
            }

            closeAddWord() {
                document.getElementById('addWordModal').classList.add('hidden');
                document.getElementById('addWordForm').reset();
            }

            async showDetail(wordId) {
                const word = this.words.find(w => w._id === wordId);
                if (!word) return;

                document.getElementById('detailWord').textContent = word.word;

                const masteryLabels = ['M·ªõi h·ªçc', 'ƒêang h·ªçc', 'Quen thu·ªôc', 'Thu·ªôc', 'Th√†nh th·∫°o', 'Ho√†n h·∫£o'];

                document.getElementById('wordDetailContent').innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <div class="text-sm font-medium text-gray-700">Nghƒ©a</div>
                            <div class="text-gray-900">${word.translation || 'ƒêang t·∫£i...'}</div>
                        </div>
                        ${word.definition ? `
                            <div>
                                <div class="text-sm font-medium text-gray-700">ƒê·ªãnh nghƒ©a</div>
                                <div class="text-gray-900">${word.definition}</div>
                            </div>
                        ` : ''}
                        ${word.example ? `
                            <div>
                                <div class="text-sm font-medium text-gray-700">V√≠ d·ª•</div>
                                <div class="text-gray-900 italic">${word.example}</div>
                            </div>
                        ` : ''}
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="text-sm font-medium text-gray-700">M·ª©c th√†nh th·∫°o</div>
                                <div class="text-gray-900">${masteryLabels[word.mastery || 0]}</div>
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-700">S·ªë l·∫ßn s·ª≠ d·ª•ng</div>
                                <div class="text-gray-900">${word.usageCount || 0}</div>
                            </div>
                        </div>
                        ${word.nextReview ? `
                            <div>
                                <div class="text-sm font-medium text-gray-700">√în t·∫≠p ti·∫øp theo</div>
                                <div class="text-gray-900">${new Date(word.nextReview).toLocaleString('vi-VN')}</div>
                            </div>
                        ` : ''}
                    </div>
                `;

                document.getElementById('wordDetailModal').classList.remove('hidden');
            }

            closeDetail() {
                document.getElementById('wordDetailModal').classList.add('hidden');
            }
        }

        // Create global instance
        const vocabularyManager = new VocabularyPageManager();

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication
            const isAuthenticated = await authManager.checkAuth();

            if (!isAuthenticated) {
                document.getElementById('authScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            } else {
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');

                // Render navigation
                navigationManager.renderNavbar(document.getElementById('navbar'));

                // Load vocabulary
                await vocabularyManager.init();
            }
        });

        // Add word form handler
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('addWordForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const word = document.getElementById('newWord').value.trim();

                if (word) {
                    try {
                        const response = await api.addVocabulary(word);
                        if (response.success) {
                            vocabularyManager.closeAddWord();
                            await vocabularyManager.loadWords();
                        }
                    } catch (error) {
                        console.error('Failed to add word:', error);
                    }
                }
            });
        });
    </script>
</body>
</html>
